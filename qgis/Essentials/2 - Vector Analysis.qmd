---
title: "Vector Analysis"
---

## What are we going to learn?

In this workshop, we will learn about:

-   Importing data from a CSV
-   Joining Tabular data
-   Overlaps/Intersections
-   Digitisation
-   Point counts within a polygon


## What is Vector Data?

Vector data is made up of points, lines, and/or polygons. They are made up of precise points with individual coordinates. Vector data is best contrasted with Raster data which has a grid of values evenly spaced apart, connected to one coordinate. Rasters are efficient at displaying large amounts of data, where vector data is very precise.

The [Map School](https://mapschool.io/) has some useful explainers of what Vector data is.

## What are we doing today?

To look at vector data, we're going to use the example of koala populations and protected areas, and use some analyses to see how they interact. The QLD Government has set koala protection as a priority for the State, but how do their priorities match up with the data? We can use QGIS and spatial analysis to ask questions of the data.


## Gather some data

We're going to explore a number of different online spatial data repositories. Please [download the full dataset here](https://github.com/uqlibrary/technology-training-assets/raw/refs/heads/master/QGIS/vector/vector_data.zip), and extract it into the qgis_vector folder you created earlier.


> In the zip file of today's data we have already trimmed it down to just QLD to save on file size

### Data Summary

You should have:

-   Point data for analysis
    -   Koala Sightings
-   Boundary Files to spatially categorise our data
    -   Koala Priority Areas
    -   Protected Areas
    -   SA2 Areas (with human population)



## Load in our data

For most of our data, we will simply be able to double click on it in the Project Home folder within the Browser window. When you load in this data, QGIS will give you a warning that your Project Projection is different to the data you're importing. Simply click cancel on this window. We will be fixing this issue later. Make sure your Project Projection remains as EPSG:7856.

Load in:

-   SA2_ERP_2021_QLD.gpkg (suburb data)

-   CAPAD2020_terrestrial_QLD.gpkg (Protected Areas)

-   koala_priority_area.gpkg

But what about the Koala Encounters location data? We need to handle this differently, as it is currently not in a spatial format, but in a csv file.

### Importing CSV data

-   Go to `Layer > Add Layer > Add Delimited Text Layer...`
-   Click the three dots `...` next to the **File name** field, navigate to the project folder, and select `koala_reduced`
-   Click the Geometry Definition drop down
    -   This should automatically identify decimalLongitude and the X field, and decimalLatitude as the Y field.
    -   You may need to set the Geometry CRS. For this data from the ALA it is EPSG:4326 - WGS84
-   Click `Add`

> It's usually the case that data like this is in EPSG:4326 - WGS84, as that is the standard used by most GPS units and Google Maps. However, it's still worth checking those details on the website you've downloaded it from. If your data doesn't come with a predefined projection, and the spatial portal doesn't specify, but it uses a Google Maps style interface, it's probably using EPSG:4326 - WGS84


## Tabular data

QGIS can deal with plain tabular data. For example, try importing the file HDI.ods: it doesn't contain any coordinates, but we can still store it as a layer and use it in our project. You can see the data it contains by opening its attribute table.

How can we add the Human Development Index (HDI) data to our existing "admin" shapefile?

### Joining tabular data

To add the HDI data to our region shapefile, we can go the the "admin" layer's properties, use the ![Join Button](https://docs.qgis.org/3.40/en/_images/join.png) `Joins` tab and click the `Add new join` button ![Add New Join Button](https://docs.qgis.org/3.40/en/_images/symbologyAdd.png) to create a new join. We can then choose the HDI data as the `Join layer`, and define what common field between the two tables we will merge on: the ISO_3166_2 code in our case.

You can now see the joined data highlighted in green in the ![Fields Tab Button](https://docs.qgis.org/3.40/en/_images/mSourceFields.png)`Fields` tab, click "OK", and check the actual values in the "admin" layer's attribute table.


## Subset our SA2 data down to SEQ - Select features using an expression

The following code will allow you to select the SA2 features that are in SEQ.

-   Right click on the reprojected SA2 layer, and select **Open Attribute Table**
-   From the Attribute Table that opens, click the Select features using an expression button: ![image](https://docs.qgis.org/3.40/en/_images/mIconExpressionSelect.png)
-   In the Select by Expression window that opens, paste the code from below into the Expression field, and then click `Select Features` in the bottom right of the window.

``` sql
 "SA4_name_2021" =  'Gold Coast' 
 OR
 "SA4_name_2021" =  'Sunshine Coast' 
  OR
 "SA4_name_2021" =  'Toowoomba' 
 OR
  "GCCSA_name_2021"  LIKE  '%Brisbane%' 
```

> This is SQL code, which is great for querying databases. This code selects any row that matches any of the criteria (this OR that). The first three look for exact matches, the last one looks to match the pattern given. The % acts like wildcard, so it's looking for any row that contains Brisbane.

-   Close the Select by Expression window and Attribute Table
-   You should see the SEQ SA2 areas highlighted in yellow (you may need to turn off other layers or zoom in).
-   To permanently save this selection, right click on the reprojected SA2 layer, and select `Export > Save Selected Features As...`
-   Save your file as `SA2_SEQ`
-   Make sure the CRS stays as `EPSG:7856 - GDA2020 / MGA zone 56`, then click `OK`

If you haven't done so already, untick and hide all the original layers we aren't using any more.

## Analysis: Spatial Overlaps

Let's find out how much of our Koala Priority areas are already under federally recognised protection. To do this we will use the Intersection tool. This tool is similar to the **Clip** tool, but rather than just cutting out the overlapping area, it also combines the Attribute Tables of the two layers.

### Intersection

-   Go to `Vector > Geoprocessing Tools > Intersection`
-   Under **Input Layer** select **CAPAD_Reproj**
-   Under **Overlay Layer** select **KPA_Reproj**
-   Click `Run`

We get an error `Feature (26) from “CAPAD_Reproj” has invalid geometry.` This is caused by little issues in the polygon layer. Sometimes when polygons are drawn or exported from online sources, they will create errors, and sometimes little slither polygons on the edges. We can investigate the source of these errors using the `Check validity` tool, but for today, we're simply going to fix them with the `Fix Geometries` tool from the Processing Toolbox.

### Fix Geometries

-   Open the Processing Toolbox by clicking the cog icon from the top menu ![Processing Toolbox](https://docs.qgis.org/3.40/en/_images/processingAlgorithm.png) (alternatively go to `View > Panels > Processing Toolbox`)
-   In the **Processing Toolbox** window `Search` for "Fix geometries"
-   Double-click on the **Fix geometries** option
-   In the **Fix Geometries** window, select `CAPAD_Reproj` from the **Input layer** options, then click `Run`
-   Right click **Fixed Geometries** in the Layer panel, click Rename Layer, and change it to **CAPAD_Fixed**

You can now re-run the **Intersection** tool with the resulting **CAPAD_Fixed** layer (instead of the **CAPAD2020_terrestrial_QLD** layer)

-   Go to `Vector > Geoprocessing Tools > Intersection`
-   Under **Input Layer** select **CAPAD_Fixed**
-   Under **Overlay Layer** select **KPA_Reproj**
-   Click `Run`

Magic. Our new layer with be the thin overlap between our two original layers, and will have their shared Attribute Tables. However, this is a double-edged sword, as it has retained the Area columns of the original CAPAD polygons. If we want to know our new shape's area, we need to calculate that.

### Field Calculator

We can use the **Field Calculator** to calculate the area of our polygon.

Select **Intersection** from the **Layers** panel, and the click the **Open Field Calculator** button ![Field Calculator Button](https://docs.qgis.org/3.40/en/_images/mActionCalculateField.png)

In the **Field calculator** window, type the following code into the **Expression** tab:

``` sql
sum($area)
```

-   \$area will give us the area of a single polygon - we could use this to create a new field in our Attribute Table based on area if we wanted to
-   sum() will add together the area for every polygon in that layer.
-   Below the text box, you will see a field titled **Preview:**, the value following that contains the results of our expression. Copy that number.
-   Click `Cancel`

Do the same **Field Calculator** steps for the original koala_priority_area.

You can now use the **Field calculator** to determine the percentage of the Koala Priority area which is currently protected. 1506573200.936991 / 5776218019.211894 = 26%

Only 26%! Let's look into this further. Perhaps our dataset is missing some new conservation areas.

Let's turn on the OpenStreetMap to see if we can see anything missing here. Let's have a look at the dense collection of koala sightings near Springwood and the Daisy Hill Conservation Park (if you can't find them, paste these coordinates **-27.581128,153.176828** into the **Coordinate** box at the bottom of the window, and change the **Scale** to **1:10000**). We can see that there are some protected bushlands in this area that aren't in our CAPAD2020 dataset. It may be that these aren't strict enough conservation areas, or our dataset may be out of date. Regardless, this gives us a good opportunity to use an important tool in GIS: Digitisation.

## Map Digitisation

You may often need to create your own points, lines, and polygons when digitising satellite data, or simply highlighting a particular area. Let's use the OpenStreeMap (in Browser, scroll down to XYZ Tiles, and double-click on OpenStreetMap) and digitise the Emu Street Bushland Refuge.

-   Go to `Layer > Create Layer > New GeoPackage Layer...`

-   Click the three dots `...` next to the **Database** section

-   Navigate to your `data > processed` folder and save the file as **ESBR_polygon**

-   From **Geometry type** select `MultiPolygon`

-   Make sure the CRS is set to `EPSG:7856 - GDA2020 / MGA zone 56`

-   Leave the other fields blank for now and click `OK`

We now have a brand new layer that we can add polygons to.

-   Select the new **ESBR_polygon** layer and then click the **Toggle Editing** pencil ![Toggle Editing Button](https://docs.qgis.org/3.40/en/_images/mActionToggleEditing.png) from the top menu (or go to `Layer > Toggle Edititng`

-   On your keyboard, press `Ctrl + .` (or click ![Add Polygon Button](https://docs.qgis.org/3.40/en/_images/mActionCapturePolygon.png) Add Polygon Feature) to start adding a new polygon

-   Zoom in to a corner of the area you want to create the polygon, and then `Left click` to start drawing your polygon (You can use the mouse wheel to zoom in, and also press and drag on the mouse wheel to navigate)

    -   A red dotted line will now appear between that first point and your cursor.

-   Continue adding points to your polygon until your return back to the start, `Right click` to stop digitising and create your polygon.

-   Leave the fid as `Autogenerate` and click `OK`

-   To save what you've done, click the **Save Layer Edits** button next to the **Toggle Editing** button

-   To finish editing your layer click the **Toggle Editing** button

You now know how to digitise a polygon, but the same steps apply for creating a point or a line layer. We created a new layer here, and you can also do the same steps to edit a pre-exisitng layer too.

The **Vertex Tool** ![Vertex Tool Button](https://docs.qgis.org/3.40/en/_images/mActionVertexToolActiveLayer.png) will allow you to move the location of points (or corners of polygons) that you have already created (you also need to click the **Toggle Editing** button for this tool)

Despite these missing Refuge area polygons, you can still see that there are a lot of koalas which are found outside of protected areas. In fact, most sightings seem to occur outside of protected areas! Is this poor protected area management, or might our data be biased by when and where people are more likely to encounter koalas?

## Analysis: How do koalas and people overlap?

### Count Points in Polygons

Earlier we looked at overlap between polygons, we can also look at points overlapping with a polygon. Let's use the Count Points in Polygons tool to quickly count the number of points from a particular layer inside a polygon. We could look at a few things here, we could look at koala sightings in protected areas or in the priority areas, but let's try to get an idea of how people and koala sightings overlap. You would expect there to be more koalas where there are fewer people, but perhaps our data is skewed by population levels.

Let's determine how many koalas are inside of each SA2 suburb.

-   Go to `Vector > Analysis Tools > Count Points in Polygons...`

-   In the **Polygons** field select `SA2_SEQ`

-   In the **Points** field select `Koalas_Reproj`

-   In the **Count field name** field type in something like `NUM_KOALAS`

-   Click the three dots `...` next to the **Count** section, and click **Save to File...**

-   Navigate to your **processed** folder and save the file as **SA2_SEQ_koalas**

-   Click `Run`

If it's being really slow, we might be able to benefit from the **Fix Geometries** tool again.

-   Click `Cancel` in the **Count Points in Polygons** window, but leave it open for now

-   In the **Processing Toolbox** double-click on the **Fix geometries** option

    -   For Input Layer choose **Koalas_Reproj**

    -   Click `Run`

-   Return to the **Count Points in Polygons** window, click `Change Parameters`

-   Change the `Points` to the new **Fixed geometries** layer

-   Click `Run`

You can now look at the **Attribute Table (F6)** for this layer to see the number of koala sightings in each suburb. Let's visualise this.

-   Click on the **SA2_SEQ_koalas** layer in the Layers panel

-   Open the Layer Styling Panel by pressing F7 (or fn + F7)

-   Change the Symbology from `Single Symbol` to `Graduated`

-   Set the **Value** to `NUM_KOALAS`

-   Choose a **Color ramp** of your liking

-   Click `Classify`

-   You might want to play with the **Mode** to get a feel for the data

Now we can quickly see how many Koalas are in each suburb.

We can go further and use the **Field Calculator** to compare koala numbers to the current human population in that area, and create a new field with that information.

-   Click on the **Field Calculator** button ![Field Calculator Button](https://docs.qgis.org/3.40/en/_images/mActionCalculateField.png){alt="image"}

    -   Under **Create a new field** set the **Output field name** to `KOALAS_PP`

    -   Set the **Output field type** to `Decimal number (real)` (we need to choose this option to ensure that we have decimals in our output)

    -   In the `Expression` tab enter `"NUM_KOALAS" / "ERP_2021"`

        -   ERP stands for Estimated Resident Population

    -   Click OK

-   Now you can change the **Value** in **Layer Styling** to `KOALA_PP`

    -   Click Classify again if needed

We can now see how koala populations compare with human populations.

## Wrap up

Today we explored projections, looked at a variety of data sources, questioned the quality of our data, used the Intersection tool, the Field Calculator, digitised a map, and used polygon point counts.

After running these tests and analyses, do we feel that there is adequate protection and conservation areas for koalas in QLD? How might you show this?

How might you use these tools in your own analysis?


## Feedback

Please visit our website to [provide feedback](https://web.library.uq.edu.au/study-and-learning-support/training-and-workshops/software-training-resources) and find upcoming training courses we have on offer.



